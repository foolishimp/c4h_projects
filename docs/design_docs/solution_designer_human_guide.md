
Applying LLM-Generated Diffs Directly with apply_diff
This guide explains how to use the apply_diff mode in prefect_runner.py to directly apply code changes generated by an LLM, bypassing the built-in discovery and solution design stages.

Overview
The apply_diff mode streamlines the process of taking a raw diff string (formatted according to specific C4H conventions) and executing the coder stage of the workflow to apply those changes to a target project.

It works by:

Reading the raw diff content from a specified file.
Automatically wrapping this content into a temporary lineage JSON file that mimics the output of the solution_designer stage.
Constructing and sending a request to the /api/v1/jobs endpoint, instructing it to start directly at the coder stage using the temporary lineage file as input.
The C4H service then executes the coder agent, which parses the diffs from the temporary lineage file and attempts to apply them to the specified project.
Using apply_diff Mode
Command:

Bash

python ./c4h_services/src/bootstrap/prefect_runner.py apply_diff \
    --project-path <path_to_target_project> \
    --diff-file <path_to_raw_diff_file.txt> \
    [--config <path_to_base_config.yml>] \
    [--host <api_host>] \
    [-P <api_port>] \
    [--poll] \
    [--poll-interval <seconds>] \
    [--max-polls <count>] \
    [--log <level>]
Required Arguments:

apply_diff: Specifies the mode.
--project-path <path_to_target_project>: The absolute or relative path to the root directory of the project where the code changes should be applied.
--diff-file <path_to_raw_diff_file.txt>: The path to a plain text file containing the raw diff string generated by the LLM, formatted using the ===CHANGE_BEGIN===...===CHANGE_END=== structure.
Optional Arguments:

--config <path_to_base_config.yml>: Path to a YAML configuration file. If provided, runtime and backup settings from this file will be used for the job. If not provided, it may attempt to use config/system_config.yml relative to the runner, or defaults will apply (backups might be disabled if not specified).
--host <api_host>: API service hostname (default: localhost).
-P <api_port>: API service port (default: 5500).
--poll: If included, the runner will poll the /jobs/{job_id} endpoint until the job completes or fails.
--poll-interval <seconds>: Wait time between polls (default: 5).
--max-polls <count>: Maximum number of polls before timing out (default: 120).
--log <level>: Set logging level (debug or normal).
Example:

Bash

python ./c4h_services/src/bootstrap/prefect_runner.py apply_diff \
    --project-path "/Users/jim/src/apps/c4h_editor/backend" \
    --diff-file "llm_generated_changes.diff" \
    --config "config/system_config.yml" \
    --poll
Generating Diff Content with an LLM
To generate compatible diff content, you need to provide the LLM with the right context and strict output instructions.

1. Input Context for LLM:

Role/Goal: Tell the LLM it's a precise code modification assistant. Its goal is to generate specific changes based on an intent and provided source code.
Source Code (source_code): Provide the relevant original code files. Using the tartxt.py output format (with == Manifest ==, == Content ==, == Start of File == markers) is a good way to structure this input. Make sure to include the full, correct file paths as they appear in the project.
Intent (intent): Provide a clear and specific description of the desired code changes (e.g., "Add logging to all functions in utils.py", "Refactor the UserService class to use async methods").
2. Output Format Instructions (Crucial):

Instruct the LLM to only output the changes in the following exact plain text format. Do not include any introductory text, explanations, summaries, or markdown formatting (like ```).

Plaintext

===CHANGE_BEGIN===
FILE: <full_path/to/file_including_name.ext>
TYPE: <create|modify|delete>
DESCRIPTION: <Brief, one-line description of the change in this block>
DIFF:
<Standard unified diff format content>
--- a/full_path/to/file_including_name.ext
+++ b/full_path/to/file_including_name.ext
@@ -line,count +line,count @@
 context line (no +/- prefix)
-removed line (starts with -)
+added line (starts with +)
 context line
 ... more diff hunks if needed ...
===CHANGE_END===

===CHANGE_BEGIN===
FILE: <full_path/to/another_file.ext>
TYPE: <create|modify|delete>
DESCRIPTION: <Description for this change>
DIFF:
<Diff content for this file>
--- a/full_path/to/another_file.ext
+++ b/full_path/to/another_file.ext
@@ ... @@
...
===CHANGE_END===

3. Key Instructions for the LLM:

Exact Format: Emphasize returning only the text formatted exactly as shown above, starting with ===CHANGE_BEGIN=== and ending with ===CHANGE_END===. Repeat for all necessary file changes.
FILE Path: Use the full, correct file path as presented in the input context. Use forward slashes (/) as path separators.
TYPE: Must be exactly create, modify, or delete.
DESCRIPTION: Keep it concise.
DIFF Format:
Use standard unified diff format.
For create: Use --- /dev/null and +++ b/path/to/new_file.ext. All content lines start with +.
For delete: Use --- a/path/to/old_file.ext and +++ /dev/null. All content lines start with -.
For modify: Use --- a/path/to/file.ext and +++ b/path/to/file.ext. Include 3 lines of context where possible. Use + for additions, - for deletions.
No Extra Text: Reiterate NO explanations, apologies, summaries, or markdown formatting (like diff ...). The output must be purely the structured diff text.
Completeness: Ensure each ===CHANGE_BEGIN=== has a corresponding ===CHANGE_END===. Complete one change block fully before starting the next.
Example Prompt Snippet for LLM:

You are a precise code modification assistant. Based on the provided SOURCE CODE and INTENT, generate the necessary code changes.

SOURCE CODE:
== Manifest ==
/path/to/file1.py
/path/to/file2.py
== Content ==
== Start of File ==
File: /path/to/file1.py
... (content of file1.py) ...
== End of File ==
== Start of File ==
File: /path/to/file2.py
... (content of file2.py) ...
== End of File ==

INTENT:
<Your detailed intent description here>

OUTPUT INSTRUCTIONS:
Return ONLY the code changes in the following exact plain text format. Do NOT include any explanations or markdown.

===CHANGE_BEGIN===
FILE: <full_path/to/file>
TYPE: <create|modify|delete>
DESCRIPTION: <one-line description>
DIFF:
<unified diff content>
===CHANGE_END===

Repeat the ===CHANGE_BEGIN===...===CHANGE_END=== block for every file that needs modification. Use '/dev/null' in the diff header for file creation or deletion as appropriate. Ensure file paths are complete and correct.
By prompting the LLM with these specific instructions, you can generate the raw diff file needed for the apply_diff mode, enabling automated application of LLM-generated code changes.